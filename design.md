# 区块链信息自动化系统 - 完整设计文档

## 📋 系统概述

本系统是一个自动化区块链信息采集、分析与简报生成系统，通过监控多个Telegram加密货币群组，使用AI技术提取有价值信息，生成深度简报并推送到指定频道。

**核心功能：**
- 多账号并发采集Telegram群组信息
- AI智能分析与信息整理
- 24小时深度简报自动生成
- Telegram频道自动推送

## 🏗️ 系统架构

### 1. 数据采集层
```
┌─────────────────────────────────────────────┐
│              Telegram 群组监控               │
├─────────────────────────────────────────────┤
│ 采集账号1 (42个频道) │ 采集账号2 (36个频道) │
└─────────────────────────────────────────────┘
        │                    │
        ▼                    ▼
┌─────────────────────────────────────────────┐
│          Telegram Adapter V2 (并发)         │
└─────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────┐
│             数据存储 (SQLite)               │
│         data/raw_messages_YYYY_MM.db        │
└─────────────────────────────────────────────┘
```

### 2. 数据处理层
```
┌─────────────────────────────────────────────┐
│             原始消息数据库                   │
└─────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────┐
│           AI 分析引擎 (DeepSeek)            │
│         遵循 setting_AI.md 逻辑             │
└─────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────┐
│          深度简报生成 (Markdown)            │
└─────────────────────────────────────────────┘
```

### 3. 输出层
```
┌─────────────────────────────────────────────┐
│           本地存储 (obsidian-tem/)          │
│       DailyReport_YYYYMMDD_to_YYYYMMDD.md   │
└─────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────┐
│         Telegram 推送 (@HDXSradar)          │
└─────────────────────────────────────────────┘
```

## 🔄 完整运行流程

### 启动方式
系统支持两种启动方式：
1. **手动启动**：双击 `launch.command`（macOS桌面脚本）
2. **自动启动**：通过cron定时任务或AI代理调用

### 完整执行流程

#### 阶段1：环境检查与初始化
```
1.1 检查环境变量 (.env)
    ├── API密钥验证
    ├── Telegram配置验证
    └── 数据库路径配置

1.2 检查配置文件状态
    ├── setting_AI.md 存在性检查
    ├── setting_collector1.md 存在性检查  
    ├── setting_collector2.md 存在性检查
    └── 配置文件内容验证

1.3 数据库状态检查
    ├── 数据目录存在性
    ├── 当前月份数据库文件
    └── 历史数据归档状态
```

#### 阶段2：配置更新检测与处理
```
2.1 AI逻辑配置检测 (setting_AI.md)
    ├── 仅提示词更新 → 自动应用
    ├── 代码变更要求 → 人工干预提醒
    └── 逻辑规则变更 → 验证兼容性

2.2 采集配置检测 (setting_collector*.md)
    ├── 频道数量变化检测
    ├── 频道列表更新验证
    └── 优先级去重检查

2.3 环境变量同步
    ├── 检查是否需要运行 sync_settings_to_env.py
    ├── 自动同步频道配置
    └── 验证同步结果
```

#### 阶段3：数据采集与处理
```
3.1 数据时间范围确定
    ├── 默认：过去24小时 (UTC+8)
    ├── 可配置：自定义时间范围
    └── 时区统一处理

3.2 数据库查询与过滤
    ├── 按时间范围查询原始消息
    ├── 按采集账号分组
    └── 初步去重处理

3.3 消息聚合与格式化
    ├── 按群组聚合消息
    ├── 格式化供AI处理
    └── 添加元数据标记
```

#### 阶段4：AI分析与简报生成
```
4.1 AI提示词构建
    ├── 基于 setting_AI.md 构建完整提示
    ├── 包含分类、去重、过滤规则
    └── 添加输出格式要求

4.2 AI调用与处理
    ├── 调用 DeepSeek API
    ├── 温度参数控制 (0.3)
    ├── 错误处理与重试

4.3 简报后处理
    ├── 格式验证与清理
    ├── 链接与引用检查
    └── 质量评估标记
```

#### 阶段5：输出与推送
```
5.1 本地存储
    ├── 保存到 obsidian-tem/ 目录
    ├── 文件名：DailyReport_YYYYMMDD_to_YYYYMMDD.md
    ├── 包含完整元数据

5.2 Telegram推送
    ├── 连接到 @HDXSradar 频道
    ├── 消息分片处理（如需要）
    ├── 推送状态验证

5.3 日志与监控
    ├── 运行日志记录
    ├── 错误报告生成
    └── 性能指标收集
```

#### 阶段6：清理与归档
```
6.1 临时文件清理
6.2 数据库维护
    ├── 旧数据归档建议
    ├── 空间使用监控
6.3 运行状态报告
```

## ⚙️ 配置管理

### 核心配置文件
1. **.env** - 环境变量（API密钥、数据库路径等）
2. **setting_AI.md** - AI整理逻辑与规则
3. **setting_collector1.md** - 采集账号1监控列表
4. **setting_collector2.md** - 采集账号2监控列表

### 配置更新处理逻辑

#### AI配置更新 (setting_AI.md)
```
检测 → 分析 → 处理
├── 仅文本/提示词更新
│   └── 自动应用到下次AI调用
├── 逻辑规则变更
│   ├── 验证与现有代码兼容性
│   └── 如兼容则自动应用
└── 代码变更要求
    ├── 标记需要人工干预
    └── 提供具体修改建议
```

#### 采集配置更新 (setting_collector*.md)
```
检测 → 同步 → 验证
├── 频道数量变化
│   ├── 自动同步到环境变量
│   └── 更新采集任务
├── 频道列表更新
│   ├── 优先级去重处理
│   └── 配置热更新
└── 配置格式验证
    ├── 语法检查
    └── 有效性验证
```

## 🚀 自动化脚本说明

### launch.command (macOS桌面脚本，由 generate_briefing.command 重命名)
```bash
# 功能特点
1. 双击即可运行完整流程
2. 详细的步骤输出
3. 错误处理与用户提示
4. 运行后保持终端窗口

# 执行权限设置
chmod +x launch.command

# 桌面使用
1. 复制到桌面
2. 双击运行
3. 查看完整日志
```

### 定时任务配置 (cron)
```bash
# 每天北京时间8:00运行
0 0 * * * cd /path/to/project && ./launch.command

# 或使用Python脚本
0 0 * * * cd /path/to/project && python3 process_24h_report.py
```

## 🔧 故障处理与恢复

### 已知风险与缓解措施
1. **Telegram FloodWait 风险**
   - **风险**: 频繁采集可能触发Telegram API限制
   - **缓解**: 
     - 使用多账号分散请求
     - 实现指数退避重试机制
     - 监控API调用频率

2. **消息长度超限**
   - **风险**: Telegram消息4096字符限制
   - **缓解**:
     - 自动检测消息长度
     - 智能分片处理
     - 关键信息优先保留

3. **数据库去重失效**
   - **风险**: 跨会话消息重复处理
   - **缓解**:
     - 持久化已处理消息ID
     - 实现消息指纹算法
     - 定期清理过期记录

4. **AI API限制**
   - **风险**: DeepSeek API调用频率限制
   - **缓解**:
     - 实现请求队列
     - 添加延迟重试
     - 备用模型降级

### 常见问题处理
1. **API密钥失效**
   - 检查 .env 文件
   - 验证API配额
   - 更新密钥后重试

2. **数据库连接失败**
   - 检查文件权限
   - 验证数据库完整性
   - 备份后重建

3. **Telegram推送失败**
   - 检查网络连接
   - 验证频道权限
   - 消息长度检查与分片

4. **AI处理失败**
   - API调用限制检查
   - 提示词格式验证
   - 降级处理方案

### 恢复流程
```
故障检测 → 原因分析 → 恢复措施 → 验证
    │          │          │        │
    ▼          ▼          ▼        ▼
日志分析  错误分类  自动修复  功能测试
```

## 📊 监控与日志

### 日志级别
- **INFO**: 正常流程记录
- **WARNING**: 可恢复问题
- **ERROR**: 需要干预的问题
- **DEBUG**: 详细调试信息

### 监控指标
1. **性能指标**
   - 采集消息数量
   - AI处理时间
   - 推送成功率

2. **质量指标**
   - 简报信息密度
   - 分类准确性
   - 用户反馈评分

3. **系统指标**
   - 数据库大小
   - API调用次数
   - 错误率统计

## 🔄 维护与升级

### 定期维护任务
1. **每周**
   - 数据库备份
   - 日志文件清理
   - 配置文件验证

2. **每月**
   - 数据库归档（按月份）
   - 性能优化检查
   - 依赖包更新

3. **每季度**
   - AI提示词优化
   - 监控频道评估
   - 系统架构评审

### 升级流程
```
需求分析 → 开发测试 → 部署验证 → 监控优化
    │          │          │          │
    ▼          ▼          ▼          ▼
版本规划  代码修改  灰度发布  效果评估
```

## 📁 文件结构说明

```
information-ai/
├── generate_briefing.command    # macOS桌面运行脚本
├── process_24h_report.py        # 主程序脚本
├── sync_settings_to_env.py      # 配置同步脚本
├── DESIGN.md                    # 本设计文档
├── README.md                    # 项目说明
├── setting_AI.md                # AI整理逻辑
├── setting_collector1.md        # 采集账号1配置
├── setting_collector2.md        # 采集账号2配置
├── .env                         # 环境变量
├── src/                         # 源代码目录
│   ├── config.py               # 配置管理
│   ├── storage.py              # 数据存储
│   └── adapters/               # 适配器
├── data/                        # 数据存储目录
│   └── raw_messages.db         # 当前数据库（实际实现）
│   └── raw_messages_*.db       # 分月数据库（设计目标）
└── obsidian-tem/               # 简报存储目录
    └── DailyReport_*.md        # 生成的简报
```

## ⚠️ 实际实现与设计差异说明

### 1. 数据流差异
- **设计目标**: 采集 → 数据库存储 → 批量处理 → AI分析
- **实际实现**: 实时采集 → 内存处理 → AI分析 → 结果存储
- **影响**: 缺少中间数据持久化层，依赖实时采集可用性

### 2. 配置同步机制
- **设计目标**: 自动检测配置变更并同步到环境变量
- **实际实现**: 桌面脚本已集成 `sync_settings_to_env.py` 调用
- **状态**: ✅ 已实现自动化同步

### 3. 虚拟环境支持
- **设计目标**: 完整的虚拟环境管理
- **实际实现**: 桌面脚本已添加虚拟环境检测与激活
- **状态**: ✅ 已实现基础支持

### 4. 消息去重机制
- **设计目标**: 持久化消息指纹，防止跨会话重复
- **实际实现**: 依赖数据库查询的时间范围过滤
- **状态**: ⚠️ 需要增强持久化去重

### 5. 消息长度处理
- **设计目标**: 智能分片与关键信息优先
- **实际实现**: 依赖AI输出的简洁性
- **状态**: ⚠️ 需要添加长度检测与分片逻辑

## 🎯 使用指南

### 快速开始
1. **配置环境**
   ```bash
   cp .env.example .env
   # 编辑 .env 填写API密钥
   ```

2. **设置监控频道**
   ```bash
   # 编辑 setting_collector1.md
   # 编辑 setting_collector2.md
   ```

3. **定义AI逻辑**
   ```bash
   # 编辑 setting_AI.md
   ```

4. **运行系统**
   ```bash
   # 方式1: 双击桌面脚本
   ./generate_briefing.command
   
   # 方式2: 命令行运行
   python3 process_24h_report.py
   ```

### 高级配置
1. **自定义时间范围**
   ```python
   # 修改 process_24h_report.py 中的时间参数
   start_time = datetime.now() - timedelta(hours=48)  # 48小时
   ```

2. **多频道推送**
   ```python
   # 修改推送目标频道
   CHANNEL_USERNAME = ["@HDXSradar", "@OtherChannel"]
   ```

3. **AI模型切换**
   ```python
   # 修改 config.py 中的模型配置
   AI_MODEL = "gpt-4"  # 或其他模型
   ```

## 📞 支持与反馈

### 问题报告
1. **日志位置**: 查看运行日志输出
2. **错误信息**: 复制完整错误信息
3. **复现步骤**: 描述操作步骤

### 功能请求
1. **需求描述**: 详细说明需求场景
2. **优先级**: 紧急/重要/一般
3. **预期效果**: 期望实现的功能

---

**文档版本**: 2.0  
**最后更新**: 2026-01-23  
**维护者**: 系统架构团队
